datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//---------------------------generator----------------------------------

generator client {
  provider = "prisma-client-js"
}

// generator custom_generator {
//   provider = "prisma-generator-fake-data"
//   output   = "./fake-data.ts"
// }

// generator nestgraphql {
//   provider                              = "node node_modules/prisma-nestjs-graphql"
//   output                                = "../src/@generated"
//   fields_Validator_from                 = "class-validator"
//   fields_Validator_input                = true
//   requireSingleFieldsInWhereUniqueInput = true
//   emitSingle                            = true
//   emitCompiled                          = true
//   purgeOutput                           = true
//   noTypeId                              = true
// }

//---------------------------------address----------------------------------

model Province {
  id     Int    @id @default(autoincrement())
  name   String @unique
  /// @HideField()   
  cities City[]
}

//Make CRUD Available
model City {
  id         Int        @id @default(autoincrement())
  name       String
  province   Province   @relation(fields: [provinceId], references: [id])
  provinceId Int
  districts  District[]
}

//Make CRUD Available
model District {
  id           Int           @id @default(autoincrement())
  name         String
  city         City          @relation(fields: [cityId], references: [id])
  cityId       Int
  subdistricts Subdistrict[]
}

model Subdistrict {
  id         Int       @id @default(autoincrement())
  name       String
  district   District  @relation(fields: [districtId], references: [id])
  districtId Int
  postalCode String
  /// @HideField()
  address    Address[] @relation("SubdistrictAddress")
}

//-----------------------------------User--------------------------------------------

//CRUD for UI
model User {
  //-------------------------- scalars --------------------------------
  id                 String    @id @default(uuid())
  fullName           String
  username           String    @unique
  email              String    @unique //owner cannot be customer and employee, vice versa
  emailVerifiedAt    DateTime? //if null, then unverified 
  password           String
  whatsappVerifiedAt DateTime? //if null, then unverified 
  whatsapp           String    @unique
  birthDate          DateTime
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime? //implement softdelete

  //-------------------------- 1 to 1 relations --------------------------------
  role           UserRole
  gender         Gender
  avatarImage    Image     @relation(fields: [avatarImageId], references: [url])
  avatarImageId  String
  customerInfo   Customer?
  customerInfoId String?
  employeeInfo   Employee?
  employeeInfoId String?
  ownerInfo      Owner?
  ownerInfoId    String?
  language       Language  @default(ID)
  theme          Theme     @default(LIGHT)

  //-------------------------- m to m relations --------------------------------
  accounts        Account[]
  addresses       Address[] //one customer can have multipe addresses, but one owner and employee can only have one address
  sessions        Session[] //one device login at a time for employee and owner
  notifications   Notification[]
  changedStatuses OrderStatusChange[]

  @@map("users")
}

model Image {
  /// @HideField({ match: ['ImagesCreate*Input','ImagesUpdate*Input']})
  fileType         FileType?
  /// @Validator.IsNumber() 
  /// @HideField({ match: ['ImagesCreate*Input','ImagesUpdate*Input']})
  fileSize         Float?
  url              String             @id
  /// @HideField({ match: ['ImagesCreate*Input','ImagesUpdate*Input']})
  createdAt        DateTime           @default(now())
  User             User[]
  PhoneCountryCode PhoneCountryCode[]
  Branch           Branch[]
  PlatformItem     PlatformItem?      @relation(fields: [platformItemId], references: [id])
  platformItemId   String?
  LaundryItem      LaundryItem?       @relation(fields: [laundryItemId], references: [id])
  laundryItemId    String?

  @@map("Images")
}

enum FileType {
  UNKNOWN
  MP4
  JPG
  PNG
  PDF
}

//No CRUD for UI
//CRUD for superUser
model PhoneCountryCode {
  id        Int    @id @default(autoincrement())
  image     Image  @relation(fields: [imageId], references: [url])
  imageId   String
  country   String
  phoneCode Int    @unique
}

//No CRUD for UI
//Read Only for SuperUser
model Session {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  device    String
  ipAddress Float
  createdAt DateTime @default(now())
}

enum UserRole {
  OWNER
  EMPLOYEE
  CUSTOMER
  SUPERUSER
}

enum Gender {
  MALE
  FEMALE
}

enum Theme {
  LIGHT
  DARK
}

enum Language {
  ID
  EN
}

//CRUD for UI
model Owner {
  //-------------------------- scalars --------------------------------
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @id
  createdAt DateTime @default(now())
  updatedAt DateTime

  //-------------------------- relations --------------------------------
  creditCard     CreditCard[]
  platformOrders PlatformOrder[]
  branches       Branch[]

  @@map("Owners")
}

//CRUD for UI
model Customer {
  //-------------------------- scalars --------------------------------
  user         User      @relation(fields: [userId], references: [id])
  userId       String    @id
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  referralCode String    @unique
  referredBy   Customer? @relation("CustomerReferral", fields: [referredById], references: [userId])
  /// @HideField({ output: false, input: true })   
  referredById String?

  //-------------------------- relations --------------------------------
  orders           ServiceOrder[]
  favoriteBranches Branch[]
  reviews          Review[]
  creditCards      CreditCard[]
  referredUsers    Customer[]     @relation("CustomerReferral")

  @@map("customers")
}

//CRUD for UI
model Employee {
  //-------------------------- scalars --------------------------------

  user            User     @relation(fields: [userId], references: [id])
  userId          String   @id
  salary          Int?
  attendanceBonus Int? //per attendance
  mealAllowance   Int?
  branch          Branch   @relation(fields: [branchId], references: [id])
  branchId        Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime

  //-------------------------- relations --------------------------------

  roles        EmployeeRole[] //one employee can be cashier, courier or production at the same time 
  serviceOrder ServiceOrder[]
  activities   Activity[]
  attendances  Attendance[]

  @@map("Employees")
}

enum EmployeeRole {
  CASHIER
  COURIER
  PRODUCTION
}

enum Activity {
  LABELLING
  SORTING
  CLEANING
  SPOTTING
  DETAILLING
  DRYING
  IRONING
  FOLDING
  PACKING
}

//CRUD for UI
model CreditCard {
  id             Int       @id @default(autoincrement())
  isAccepted     Boolean
  lastChecked    DateTime?
  cardHolderName String
  customer       Customer? @relation(fields: [customerId], references: [userId])
  customerId     String?
  owner          Owner?    @relation(fields: [ownerId], references: [userId])
  ownerId        String?
  cardNumber     String    @unique
  expMonth       Int
  expYear        Int
  cvv            String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

//-----------------------------------Account----------------------------------------------

model Account {
  //---------------------------------
  id                     Int             @id @default(autoincrement())
  accountNumber          Float?
  /// @Validator.MinLength(2)
  /// @Validator.MaxLength(20)
  /// @Validator.IsAlpha()
  name                   String
  /// @HideField({ output: false, input: true })
  createdAt              DateTime        @default(now())
  /// @HideField({ output: false, input: true })
  updatedAt              DateTime        @updatedAt
  user                   User            @relation(fields: [userId], references: [id])
  userId                 String
  accountCategory        AccountCategory
  /// @HideField({ match: 'AccountCreate*Input' })
  transactionOrigins     Transaction[]   @relation("origin")
  /// @HideField({ match: 'AccountCreate*Input' })
  transactionDestination Transaction[]   @relation("destination")
}

enum AccountCategory {
  COMISSION
  CASH
  PLATFORM
  BANK
  DEBT
  POINT
}

//Make Read only without update, delete
model Transaction {
  id                  Int                 @id @default(autoincrement())
  /// @Validator.IsNumber() 
  /// @Validator.IsNotEmpty()
  amount              Float
  proofUrl            String?
  /// @HideField({ match: ['TransactionCreate*Input','TransactionUpdate*Input']})     
  status              TransactionStatus
  transactionCategory TransactionCategory
  /// @HideField({ match: ['TransactionCreate*Input','TransactionUpdate*Input']})   
  fromAccount         Account             @relation("origin", fields: [fromAccountId], references: [id])
  /// @HideField({ match: ['TransactionCreate*Input','TransactionUpdate*Input']})  
  fromAccountId       Int
  /// @HideField({ match: ['TransactionCreate*Input','TransactionUpdate*Input']})  
  toAccount           Account             @relation("destination", fields: [toAccountId], references: [id])
  /// @HideField({ match: ['TransactionCreate*Input','TransactionUpdate*Input']})  
  toAccountId         Int
  invoice             Invoice?            @relation(fields: [invoiceId], references: [id])
  invoiceId           Int?
  /// @HideField({ match: 'TransactionUpdate*Input' })
  withdrawalRequestId Int?                @unique
  /// @HideField({ match: ['TransactionCreate*Input','TransactionUpdate*Input']})   
  uniqueCode          Int?
  /// @HideField({ match: ['TransactionCreate*Input','TransactionUpdate*Input']})   
  createdAt           DateTime            @default(now())

  @@index([amount], name: "amount")
  @@index([fromAccountId], name: "from_account_id")
  @@index([toAccountId], name: "to_account_id")
  @@index([createdAt], name: "created_at")
}

enum TransactionCategory {
  INVESTMENT
  INVESTMENT_RETURN
  COMISSION_BONUS
  WITHDRAWAL
  MEMBER_REGISTRATION
  STUDENT_REGISTRATION
  REFERRING
  REDEEMING
}

enum TransactionStatus {
  PROCESSING
  PENDING
  FAILED
  CANCELLED
  COMPLETED
}

//Make CRU Available, cannot be deleted
model Invoice {
  id              Int            @id @default(autoincrement())
  /// @Validator.IsNotEmpty()
  /// @Validator.IsNumber() 
  adminFee        Float
  /// @Validator.IsNotEmpty()
  /// @Validator.IsNumber() 
  amount          Float
  /// @HideField({ output: false, input: true })   
  uniqueCode      Int
  /// @HideField({ match: 'InvoiceUpdate*Input' })
  serviceOrder    ServiceOrder?  @relation(fields: [serviceOrderId], references: [id])
  /// @HideField({ match: 'InvoiceUpdate*Input' })
  platformOrder   PlatformOrder? @relation(fields: [platformOrderId], references: [id])
  /// @HideField({ match: 'InvoiceUpdate*Input' })
  transactions    Transaction[]
  /// @HideField({ output: false, input: true }) 
  createdAt       DateTime       @default(now())
  serviceOrderId  Int?
  platformOrderId Int?
}

//-----------------------------------Addresses--------------------------------------------

//CRUD for UI
model Address {
  id            Int             @id @default(autoincrement())
  latitude      Float? //for google map
  longitude     Float? //for google map
  label         String
  street        String
  /// @Validator.IsNotEmpty()
  subdistrict   Subdistrict     @relation("SubdistrictAddress", fields: [subdistrictId], references: [id])
  // @HideField({ match: 'AddressCreate*Input' })
  subdistrictId Int
  user          User?           @relation(fields: [userId], references: [id])
  Branch        Branch?
  platformOrder PlatformOrder[]
  serviceOrder  ServiceOrder[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  userId        String?
}

//CRUD for UI
//CRUD only available for owner user
model Branch {
  id             Int                        @id @default(autoincrement())
  name           String
  isActive       Boolean                    @default(true)
  description    String?
  image          Image                      @relation(fields: [imageId], references: [url])
  imageId        String
  address        Address                    @relation(fields: [addressId], references: [id])
  addressId      Int                        @unique
  phone          String?
  email          String?
  owner          Owner                      @relation(fields: [ownerId], references: [userId])
  ownerId        String
  orders         ServiceOrder[]
  bussinessHours BusinessHour[]
  employees      Employee[]
  reviews        Review[]
  schedules      Schedule[]
  services       BranchLaundryItemService[]
  customers      Customer[]
  machines       Machine[]
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime
}

//CRUD for UI
//CRUD Only available for branch owner
model BranchLaundryItemService {
  //-------------------------- scalars --------------------------------
  id               Int            @id @default(autoincrement())
  name             String
  description      String?
  branch           Branch         @relation(fields: [branchId], references: [id])
  branchId         Int
  laundryItem      LaundryItem    @relation(fields: [laundryItemId], references: [id])
  laundryItemId    String
  durationInMinute Int
  maxWeight        Float?
  minWeight        Float?
  cost             Int?
  salePrice        Int
  isActive         Boolean        @default(true)
  isOnSale         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  //-------------------------- relations --------------------------------
  orders           ServiceOrder[]
  activities       Activity[] //branch can decide what are the activities involved in this service

  @@map("BranchLaundryItemServices")
}

//no update nor delete operation for UI
//CRUD only available to superUser
model LaundryItem {
  //-------------------------- scalars --------------------------------
  id                  String              @id @default(cuid())
  name                String
  description         String?
  unitOfMeasure       UnitOfMeasure       @relation(fields: [unitOfMeasureId], references: [id])
  unitOfMeasureId     Int
  category            LaundryItemCategory @relation(fields: [categoryId], references: [id])
  categoryId          Int
  requiresDryCleaning Boolean             @default(false)
  requiresIron        Boolean             @default(false) // whether the service requires ironing
  requiresFold        Boolean             @default(false) // whether the service requires folding
  requiresPack        Boolean             @default(false) // whether the service requires packing
  requiresHang        Boolean             @default(false) // whether the service requires hanging
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  //-------------------------- relations --------------------------------

  images          Image[]
  branchServices  BranchLaundryItemService[]
  marketSalePrice MarketSalePriceHistory[]

  @@map("LaundryItems")
}

//backend cron job auto calculate from average market price (BranchLaundryService model)
model MarketSalePriceHistory {
  id            Int         @id @default(autoincrement())
  price         Int
  laundry       LaundryItem @relation(fields: [laundryItemId], references: [id])
  laundryItemId String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("MarketSalePriceHistories")
}

//no update,delete operation for UI
//CRUD only available to superUser
model LaundryItemCategory {
  id        Int           @id @default(autoincrement())
  name      String
  items     LaundryItem[] //one category can have multiple items
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("LaundryItemCategories")
}

//no update,delete operation for UI
//CRUD only available to superUser
model UnitOfMeasure {
  id           Int           @id @default(autoincrement())
  name         String
  abbreviation String?
  conversion   Float         @default(1.0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime
  laundryItems LaundryItem[]

  @@map("UnitOfMeasures")
}

//no update,delete operation for UI
//CRUD only available to superUser
//items for selling to owner like platform subscription,machines, soaps etc
model PlatformItem {
  id          String          @id @default(cuid())
  name        String
  price       Int
  description String?
  images      Image[]
  stock       Int?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime
  orders      PlatformOrder[]
}

//Where the Owner ordering a product from platform
//Can be created,read,edit but cannot be deleted by UI
model PlatformOrder {
  id        Int                 @id @default(autoincrement())
  owner     Owner               @relation(fields: [ownerId], references: [userId])
  ownerId   String
  statuses  OrderStatusChange[] //to track statuses
  items     PlatformItem[]
  address   Address             @relation(fields: [addressId], references: [id])
  addressId Int
  payment   Payment             @relation(fields: [paymentId], references: [id])
  paymentId Int                 @unique //must be full paid
  createdAt DateTime            @default(now())
  updatedAt DateTime
  deletedAt DateTime? //implement softdelete
  Invoice   Invoice[]
}

//Only Read on UI
model OrderStatusChange {
  id              Int            @id @default(autoincrement())
  orderId         Int
  oldStatus       OrderStatus
  newStatus       OrderStatus
  changedBy       User           @relation(fields: [changedById], references: [id])
  changedById     String
  platformOrder   PlatformOrder? @relation(fields: [platformOrderId], references: [id])
  platformOrderId Int?
  ServiceOrder    ServiceOrder?  @relation(fields: [ServiceOrderId], references: [id])
  ServiceOrderId  Int?
  changedAt       DateTime       @default(now())
}

//Where the Customer ordering a product from Branch
//Can be created,read,edit but cannot be deleted for UI
model ServiceOrder {
  id              Int                        @id @default(autoincrement())
  type            OrderType
  customer        Customer                   @relation(fields: [customerId], references: [userId])
  customerId      String
  employee        Employee?                  @relation(fields: [employeeId], references: [userId])
  employeeId      String?
  voucher         Voucher?                   @relation(fields: [voucherId], references: [id])
  voucherId       Int?
  statuses        OrderStatusChange[] //to track statuses
  items           BranchLaundryItemService[]
  platformFee     Int?
  discount        Int?
  address         Address?                   @relation(fields: [addressId], references: [id])
  addressId       Int?
  pickupTime      DateTime? // estimated pickup time
  deliveryTime    DateTime? // estimated delivery time
  pickupMessage   String? // message for the pickup/delivery person
  deliveryMessage String? // message for the pickup/delivery person
  instructions    String? // additional instructions for the order
  branch          Branch                     @relation(fields: [brandId], references: [id])
  brandId         Int
  payments        Payment[]
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime
  deletedAt       DateTime? //implement softdelete
  Invoice         Invoice[]
}

enum OrderType {
  DROPSERVICE
  SELFSERVICE
  DELIVERYSERVICE
}

enum OrderStatus {
  ORDERPENDING
  ORDERPROCESSING
  ORDERDONE
  ORDERSHIPPED
  ORDERDELIVERED
  ORDERCANCELLED
  ORDERRETURNED
}

//Create and read only, no delete and no update for UI
model Payment {
  id              Int            @id @default(autoincrement())
  amount          Int
  serviceOrder    ServiceOrder?  @relation(fields: [serviceOrderId], references: [id])
  serviceOrderId  Int?
  platformOrder   PlatformOrder?
  platformOrderId Int?
  method          PaymentMethod
  status          PaymentStatus
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  deletedAt       DateTime? //implement softdelete
}

enum PaymentMethod {
  CASH
  QRIS
  CREDITCARD
  DEBITCARD
  EWALLET
  PLATFORMWALLET
  BANKTRANSFER
}

enum PaymentStatus {
  PAYMENTPENDING
  PAYMENTUNPAID
  PAYMENTHALFPAID
  PAYMENTFULLPAID
  PAYMENTCANCELLED
  PAYMENTFAILED
  PAYMENTREFUNDED
}

enum PlatformWalletTransactionCategory {
  TOPUP
  WITHDRAWAL
  ORDERPAYMENT
  REFUND
}

enum PlatformWalletTransactionType {
  DEBIT
  CREDIT
}

//CRUD for UI
//Update, Delete disable for owner
model Review {
  id               Int      @id @default(autoincrement())
  imageUrls        String[]
  content          String
  cleanlinessScore Float
  speedScore       Float
  qualityScore     Float
  reviewBy         Customer @relation(fields: [reviewById], references: [userId])
  reviewById       String
  branch           Branch   @relation(fields: [branchId], references: [addressId])
  branchId         Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

//Create and Read only for UI
model Attendance {
  id            Int                      @id @default(autoincrement())
  status        EmployeeAttendanceStatus
  latitude      Float? //for google map
  longitude     Float? //for google map
  ImageUrl      String
  employee      Employee                 @relation(fields: [employeeId], references: [userId])
  employeeId    String
  timeIn        DateTime
  timeOut       DateTime
  reason        String?
  latePenalty   Int?
  absentPenalty Int?
  overtimeBonus Int?
  createdAt     DateTime                 @default(now())
  deletedAt     DateTime? //Implement softdelete
}

enum EmployeeAttendanceStatus {
  PRESENT
  ABSENT
  OVERTIME
  LATE
  LEAVE
  HOLIDAY
}

//CRUD for UI
//available for branch and owner only
model Schedule {
  id             Int      @id @default(autoincrement())
  dayOfWeek      Int      @default(0)
  openTime       String
  closeTime      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  branch         Branch   @relation(fields: [branchId], references: [id])
  branchId       Int
  maxOrders      Int?
  availableSlots Int?
  isClosed       Boolean? @default(false) // flag indicating whether this schedule is closed or not
}

model BusinessHour {
  id        Int      @id @default(autoincrement())
  day       Day
  openTime  DateTime
  closeTime DateTime
  branch    Branch[]
}

enum Day {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model Notification {
  id        Int              @id @default(autoincrement())
  title     String
  subTitle  String?
  content   String
  type      NotificationType
  user      User             @relation(fields: [userId], references: [id])
  createdAt DateTime         @default(now())
  isRead    Boolean
  userId    String
}

enum NotificationType {
  ORDERSTATUS
  WASHINGMACHINESTATUS
  LAUNDRY
  DISCOUNT
}

//CRUD only for branch
model Machine {
  id         Int              @id @default(autoincrement())
  status     MachineStatus
  isOnline   Boolean          @default(false)
  branch     Branch           @relation(fields: [branchId], references: [id])
  capacity   Int // in kilogram
  branchId   Int
  category   MachineCategory? @relation(fields: [categoryId], references: [id])
  categoryId Int?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime
}

//No CRUD UI
model MachineCategory {
  id        Int       @id @default(autoincrement())
  name      String
  machines  Machine[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

enum MachineStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  BROKEN
  OTHER
}

//CRUD for UI
//Create, Read, Update for superUser, Read for Owner
model Voucher {
  id            Int            @id @default(autoincrement())
  code          String         @unique
  name          String
  description   String?
  image         String?
  startDate     DateTime
  endDate       DateTime
  minOrderValue Int?
  discountType  DiscountType
  discountValue Int
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  deletedAt     DateTime? //implement softdelete
  serviceOrders ServiceOrder[] //the orders that used this voucher promo
}

enum DiscountType {
  PERCENTAGE
  AMOUNT
}
